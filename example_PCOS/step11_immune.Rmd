```{r}
library("IOBR")
rt=read.table('data/merge_count_deg_preremove.txt', header=T, sep="\t", check.names=F, row.names=1)
```


```{r}
set.seed(1314)
ciber=IOBR::deconvo_cibersort(eset=rt,arrays = T,perm = 1000)
```

```{r}
outTab <- ciber
# outTab=outTab[outTab[,"P-value"]<0.05,]
outTab=as.matrix(outTab[,1:(ncol(outTab)-3)])
outTab=rbind(id=colnames(outTab),outTab)
write.table(outTab, file="data/CIBERSORT-Results.csv", sep="\t", quote=F, col.names=F,row.names = F)
# rm(list = ls())
```

```{r}
library(pheatmap)
library(corrplot)

inputFile="data/CIBERSORT-Results.csv" 
#??ȡ????ϸ???????ļ?
rt=read.table(inputFile, header=T, sep="\t", check.names=F, row.names=1)
```

```{r}
group_list1=c(rep('CT',3),rep('PC',3))
group_list2=c(rep('CT',4),rep('PC',4))
group_list3=c(rep('CT',3),rep('PC',3))

group_list=c(group_list1,group_list2,group_list3)
group_list=factor(group_list,levels=c('CT','PC'))
```



```{r}
# con=grepl("_Control", rownames(rt), ignore.case=T)     #??????????Ʒ
# treat=grepl("_Treat", rownames(rt), ignore.case=T)     #ʵ????????Ʒ
con <- group_list=="CT"
treat <- group_list=="PC"
conData=rt[con,]           #??????????ϸ???ĺ?��
treatData=rt[treat,]       #ʵ????????ϸ???ĺ?��
conNum=nrow(conData)
treatNum=nrow(treatData)
data=t(rbind(conData,treatData))
```

```{r}
#׼??ע???ļ?
data=data[apply(data,1,sd)>0,]
Type=c(rep("Control",conNum), rep("Treat",treatNum))
names(Type)=colnames(data)
Type=as.data.frame(Type)
#??????ͼ
pdf(file="Figure6/heatmap.pdf", width=7, height=4)
pheatmap(data, 
         annotation_col=Type, 
         color=colorRampPalette(c(rep("blue",3), "white", rep("red",3)))(50),
         cluster_cols=F,
         show_colnames=F,
         scale="row",
         fontsize = 7,
         fontsize_row=7,
         fontsize_col=7)
dev.off()
```
```{r}
treatData=treatData[,apply(treatData,2,sd)>0]
pdf("Figure6/corHeatmap.pdf", width=12, height=12)
corrplot(corr=cor(treatData),
         method = "color",          #ͼ?ε?չʾ??ʽ
         order = "hclust",          #????ϸ??????????ʽ
         tl.col="black",            #??????ɫ
         number.cex = 0.8,          #????ϵ????????С
         addCoef.col = "black",     #????ϵ????????ɫ
         col=colorRampPalette(c("blue", "white", "red"))(50),     #ͼ?ε???ɫ
         )
dev.off()
```
```{r}
library(vioplot) 
#????С????ͼ
conData=rt[con,]           #??ȡ????????????
treatData=rt[treat,]       #??ȡʵ??????????
conNum=nrow(conData)          #????????Ʒ??Ŀ
treatNum=nrow(treatData)      #ʵ??????Ʒ??Ŀ
rt=rbind(conData,treatData)

outTab=data.frame()
pdf(file="./Figure6/vioplot.pdf", width=13, height=8)
par(las=1,mar=c(10,6,3,3))
x=c(1:ncol(rt))
y=c(1:ncol(rt))
plot(x, y,
     xlim=c(0,(3*ncol(rt)-3)), ylim=c(min(rt), max(rt)+0.05),
     main="", xlab="", ylab="Fraction",
     pch=21,
     col="white",
     xaxt="n")

#??ÿ??????ϸ??????ѭ????????С????ͼ??????????��ɫ??ʾ??ʵ?????ú?ɫ??ʾ
for(i in 1:ncol(rt)){
	  if(sd(rt[1:conNum,i])==0){
	    rt[1,i]=0.00001
	  }
	  if(sd(rt[(conNum+1):(conNum+treatNum),i])==0){
	    rt[(conNum+1),i]=0.00001
	  }
	  #??ȡ????????ʵ??????Ʒ??????
	  conData=rt[1:conNum,i]
	  treatData=rt[(conNum+1):(conNum+treatNum),i]
	  #????С????ͼ
	  vioplot(conData,at=3*(i-1),lty=1,add = T,col = 'blue')
	  vioplot(treatData,at=3*(i-1)+1,lty=1,add = T,col = 'red')
	  #????????
	  wilcoxTest=wilcox.test(conData,treatData)
	  p=wilcoxTest$p.value
	  if(p<0.05){
	      cellPvalue=cbind(Cell=colnames(rt)[i],pvalue=p)
		  outTab=rbind(outTab,cellPvalue)
	  }
	  mx=max(c(conData,treatData))
	  lines(c(x=3*(i-1)+0.2,x=3*(i-1)+0.8),c(mx,mx))
	  #??С????ͼ???Ϸ????ϲ?????pvalue
	  text(x=3*(i-1)+0.5, y=mx+0.02, labels=ifelse(p<0.001, paste0("p<0.001"), paste0("p=",sprintf("%.03f",p))), cex = 0.8)
}

#????ͼ??
legend("topright", 
       c("Control", "Treat"),
       lwd=3,bty="n",cex=1,
       col=c("blue","red"))
#??X??????????ϸ????????
text(seq(1,(3*ncol(rt)-2),3), -0.03, xpd=NA, labels=colnames(rt), cex=1, srt=45, pos=2)
dev.off()

#????????ϸ???Ͳ???pvalue??????
write.table(outTab, file="data/immuneDiff.txt", sep="\t", row.names=F, quote=F)
```

```{r}

```

