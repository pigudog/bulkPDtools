```{r}
#???ð?
library(limma)
library(reshape2)
library(ggpubr)
library(ggExtra)

gene="LPIN2"                          #??????????(?????о???Ŀ???????????޸?)
expFile="data/merge.normalize3.txt"             #?????????ļ?
immFile="data/CIBERSORT-Results.csv"     #????ϸ???????????ļ?

```

```{r}
#??ȡ?????????ļ?,???????ݽ??д???
rt=read.table(expFile, header=T, sep="\t", check.names=F)
rt=as.matrix(rt)
rownames(rt)=rt[,1]
```


```{r}
exp=rt[,2:ncol(rt)]
dimnames=list(rownames(exp),colnames(exp))
data=matrix(as.numeric(as.matrix(exp)),nrow=nrow(exp),dimnames=dimnames)
data=avereps(data)
```


```{r}
#ȥ????????????Ʒ
group_list1=c(rep('CT',3),rep('PC',3))
group_list2=c(rep('CT',4),rep('PC',4))
group_list3=c(rep('CT',3),rep('PC',3))

group_list=c(group_list1,group_list2,group_list3)
group_list=factor(group_list,levels=c('CT','PC'))
# Type=gsub("(.*)\\_(.*)", "\\2", colnames(data))
# data=data[,Type=="Treat",drop=F]
data = data[,group_list=="PC"]
```


```{r}
#??ȡĿ???????ı???��
data=t(data[gene,,drop=F])
data=as.data.frame(data)

#??ȡ????ϸ???????ļ?
immune=read.table(immFile, header=T, sep="\t", check.names=F, row.names=1)

#???ݺϲ?
sameSample=intersect(row.names(immune), row.names(data))
rt=cbind(immune[sameSample,,drop=F], data[sameSample,,drop=F])
```


```{r}
#??????ϸ??????ѭ??????????????ɢ??ͼ
outTab=data.frame()
for(i in colnames(rt)[1:(ncol(rt)-1)]){
	#??ȡĿ???????ı???��??????ϸ???ĺ?��
	x=as.numeric(rt[,gene])
	y=as.numeric(rt[,i])
	if(sd(y)==0){y[1]=0.00001}
	#?????Լ???
	cor=cor.test(x, y, method="spearman")
	outVector=cbind(Gene=gene, Cell=i, cor=cor$estimate, pvalue=cor$p.value)
	outTab=rbind(outTab,outVector)
	
	#????????????????ϸ?????п??ӻ?, ??????????ͼ??
	if(cor$p.value<0.05){
		outFile=paste0("./Figure6/",gene,"cor.", i, ".pdf")
		df1=as.data.frame(cbind(x,y))
		p1=ggplot(df1, aes(x, y)) + 
				  xlab(paste0(gene, " expression")) + ylab(i)+
				  geom_point() + geom_smooth(method="lm",formula = y ~ x) + theme_bw()+
				  stat_cor(method = 'spearman', aes(x =x, y =y))
		p2=ggMarginal(p1, type="density", xparams=list(fill = "#FD7446FF"), yparams=list(fill = "#3B4992FF"))
		#??????????ͼ??
		pdf(file=outFile, width=5, height=4.3)
		print(p2)
		dev.off()
	}
}
```


```{r}
#????????ϸ???????ԵĽ???
write.table(outTab, file=paste0("data/",gene,"cor.immune.result.txt"), sep="\t", row.names=F, quote=F)
```

```{r}
gene="ACSS2"
data=matrix(as.numeric(as.matrix(exp)),nrow=nrow(exp),dimnames=dimnames)
data=avereps(data)
data = data[,group_list=="PC"]
data=t(data[gene,,drop=F])
data=as.data.frame(data)
#???ݺϲ?
sameSample=intersect(row.names(immune), row.names(data))
rt=cbind(immune[sameSample,,drop=F], data[sameSample,,drop=F])

outTab=data.frame()
for(i in colnames(rt)[1:(ncol(rt)-1)]){
	#??ȡĿ???????ı???��??????ϸ???ĺ?��
	x=as.numeric(rt[,gene])
	y=as.numeric(rt[,i])
	if(sd(y)==0){y[1]=0.00001}
	#?????Լ???
	cor=cor.test(x, y, method="spearman")
	outVector=cbind(Gene=gene, Cell=i, cor=cor$estimate, pvalue=cor$p.value)
	outTab=rbind(outTab,outVector)
	
	#????????????????ϸ?????п??ӻ?, ??????????ͼ??
	if(cor$p.value<0.06){
		outFile=paste0("./Figure6/",gene,"cor.", i, ".pdf")
		df1=as.data.frame(cbind(x,y))
		p1=ggplot(df1, aes(x, y)) + 
				  xlab(paste0(gene, " expression")) + ylab(i)+
				  geom_point() + geom_smooth(method="lm",formula = y ~ x) + theme_bw()+
				  stat_cor(method = 'spearman', aes(x =x, y =y))
		p2=ggMarginal(p1, type="density", xparams=list(fill = "#FD7446FF"), yparams=list(fill = "#3B4992FF"))
		#??????????ͼ??
		pdf(file=outFile, width=5, height=4.3)
		print(p2)
		dev.off()
	}
}
#????????ϸ???????ԵĽ???
write.table(outTab, file=paste0("data/",gene,"cor.immune.result.txt"), sep="\t", row.names=F, quote=F)
```
```{r}
gene="NR4A1"
data=matrix(as.numeric(as.matrix(exp)),nrow=nrow(exp),dimnames=dimnames)
data=avereps(data)
data = data[,group_list=="PC"]
data=t(data[gene,,drop=F])
data=as.data.frame(data)
#???ݺϲ?
sameSample=intersect(row.names(immune), row.names(data))
rt=cbind(immune[sameSample,,drop=F], data[sameSample,,drop=F])

outTab=data.frame()
for(i in colnames(rt)[1:(ncol(rt)-1)]){
	#??ȡĿ???????ı???��??????ϸ???ĺ?��
	x=as.numeric(rt[,gene])
	y=as.numeric(rt[,i])
	if(sd(y)==0){y[1]=0.00001}
	#?????Լ???
	cor=cor.test(x, y, method="spearman")
	outVector=cbind(Gene=gene, Cell=i, cor=cor$estimate, pvalue=cor$p.value)
	outTab=rbind(outTab,outVector)
	
	#????????????????ϸ?????п??ӻ?, ??????????ͼ??
	if(cor$p.value<0.07){
		outFile=paste0("./Figure6/",gene,"cor.", i, ".pdf")
		df1=as.data.frame(cbind(x,y))
		p1=ggplot(df1, aes(x, y)) + 
				  xlab(paste0(gene, " expression")) + ylab(i)+
				  geom_point() + geom_smooth(method="lm",formula = y ~ x) + theme_bw()+
				  stat_cor(method = 'spearman', aes(x =x, y =y))
		p2=ggMarginal(p1, type="density", xparams=list(fill = "#FD7446FF"), yparams=list(fill = "#3B4992FF"))
		#??????????ͼ??
		pdf(file=outFile, width=5, height=4.3)
		print(p2)
		dev.off()
	}
}
#????????ϸ???????ԵĽ???
write.table(outTab, file=paste0("data/",gene,"cor.immune.result.txt"), sep="\t", row.names=F, quote=F)
```

```{r}
gene="CYBB"
data=matrix(as.numeric(as.matrix(exp)),nrow=nrow(exp),dimnames=dimnames)
data=avereps(data)
data = data[,group_list=="PC"]
data=t(data[gene,,drop=F])
data=as.data.frame(data)
#???ݺϲ?
sameSample=intersect(row.names(immune), row.names(data))
rt=cbind(immune[sameSample,,drop=F], data[sameSample,,drop=F])

outTab=data.frame()
for(i in colnames(rt)[1:(ncol(rt)-1)]){
	#??ȡĿ???????ı???��??????ϸ???ĺ?��
	x=as.numeric(rt[,gene])
	y=as.numeric(rt[,i])
	if(sd(y)==0){y[1]=0.00001}
	#?????Լ???
	cor=cor.test(x, y, method="spearman")
	outVector=cbind(Gene=gene, Cell=i, cor=cor$estimate, pvalue=cor$p.value)
	outTab=rbind(outTab,outVector)
	
	#????????????????ϸ?????п??ӻ?, ??????????ͼ??
	if(cor$p.value<0.07){
		outFile=paste0("./Figure6/",gene,"cor.", i, ".pdf")
		df1=as.data.frame(cbind(x,y))
		p1=ggplot(df1, aes(x, y)) + 
				  xlab(paste0(gene, " expression")) + ylab(i)+
				  geom_point() + geom_smooth(method="lm",formula = y ~ x) + theme_bw()+
				  stat_cor(method = 'spearman', aes(x =x, y =y))
		p2=ggMarginal(p1, type="density", xparams=list(fill = "#FD7446FF"), yparams=list(fill = "#3B4992FF"))
		#??????????ͼ??
		pdf(file=outFile, width=5, height=4.3)
		print(p2)
		dev.off()
	}
}
#????????ϸ???????ԵĽ???
write.table(outTab, file=paste0("data/",gene,"cor.immune.result.txt"), sep="\t", row.names=F, quote=F)
```

